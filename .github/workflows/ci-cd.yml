name: 'CI/CD Pipeline'

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  lint-and-type-check:
    name: ğŸ” Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“‚ Install Dependencies
        run: npm ci

      - name: ğŸ” Run ESLint
        run: npm run lint

      - name: ğŸ” Type Check
        run: npm run type-check

      - name: ğŸ¨ Check Prettier
        run: npm run format:check

  build:
    name: ğŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    needs: lint-and-type-check
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“‚ Install Dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build Project
        run: npm run build
        env:
          NEXT_PUBLIC_APP_VERSION: ${{ github.sha }}

      - name: ğŸ“Š Bundle Analysis
        run: du -sh out/*

      - name: ğŸ“¦ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: out/
          retention-days: 30

  deploy-netlify:
    name: ğŸŒ Deploy to Netlify
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: ğŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: out/

      - name: ğŸš€ Deploy to Netlify (Demo)
        run: |
          echo "Build artifacts ready for deployment"
          echo "Deploy command: netlify deploy --prod --dir=out"
          echo "Note: Configure deployment secrets in repository settings for production"
          ls -la out/ || echo "Build directory not found"

  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: lint-and-type-check
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“‚ Install Dependencies
        run: npm ci

      - name: ğŸ”’ Run npm audit
        run: npm audit --audit-level=high

      - name: ğŸ” Run CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: typescript

      - name: ğŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  lighthouse:
    name: ğŸ” Lighthouse Performance
    runs-on: ubuntu-latest
    needs: deploy-netlify
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            https://sistema-medicamentos-dhs.netlify.app
            https://sistema-medicamentos-dhs.netlify.app/cidadao
            https://sistema-medicamentos-dhs.netlify.app/promotor
            https://sistema-medicamentos-dhs.netlify.app/defensoria
          configPath: './lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true

  notify-success:
    name: ğŸ“¢ Notify Success
    runs-on: ubuntu-latest
    needs: [deploy-netlify, lighthouse]
    if: success() && github.ref == 'refs/heads/main'
    steps:
      - name: ğŸ“¢ Success Notification
        run: |
          echo "âœ… Deploy realizado com sucesso!"
          echo "ğŸŒ Site: https://sistema-medicamentos-dhs.netlify.app"
          echo "ğŸ“Š Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Autor: ${{ github.actor }}"

  notify-failure:
    name: âŒ Notify Failure
    runs-on: ubuntu-latest
    needs: [build, deploy-netlify]
    if: failure()
    steps:
      - name: âŒ Failure Notification
        run: |
          echo "âŒ Deploy falhou!"
          echo "ğŸ“Š Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Autor: ${{ github.actor }}"
          echo "ğŸ”— Verifique os logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
